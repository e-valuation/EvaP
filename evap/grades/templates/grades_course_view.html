{% extends 'grades_course_base.html' %}
{% load static %}

{% block content %}
    {{ block.super }}

    <h3 class="mb-3">{{ course.name }} ({{ semester.name }})</h3>

    <div class="card mb-3">
        <div class="card-header">
            {% trans 'Uploaded grade documents' %}
        </div>
        <div class="card-body">
            {% if grade_documents %}
                <table class="table table-striped table-vertically-aligned">
                    <thead>
                        <tr>
                            <th style="width: 40%">{% trans 'Description' %}</th>
                            <th style="width: 20%">{% trans 'Type' %}</th>
                            <th style="width: 25%">{% trans 'Last edited' %}</th>
                            <th style="width: 15%">{% trans 'Actions' %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade_document in grade_documents %}
                            <tr id="grade_document-row-{{ grade_document.id }}">
                                <td>{{ grade_document.description }}</td>
                                <td>{{ grade_document.get_type_display }}</td>
                                <td>{{ grade_document.last_modified_time }}, {% trans 'by' %} {{ grade_document.last_modified_user }}</td>
                                <td>
                                    <a href="{% url 'grades:download_grades' grade_document.id %}" class="btn btn-sm btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Download' %}"><span class="fas fa-download"></span></a>
                                    {% if user.is_grade_publisher %}
                                        <a href="{% url 'grades:edit_grades' grade_document.id %}" class="btn btn-sm btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Edit' %}"><span class="fas fa-pencil"></span></a>
                                        <confirmation-modal confirm-button-class="btn-danger" data-delete-document="{{ grade_document.id }}">
                                            <span slot="title">{% trans 'Delete grade document' %}</span>
                                            <span slot="action-text">{% trans 'Delete grade document' %}</span>
                                            <span slot="question">
                                                {% blocktrans with description=grade_document.description %}
                                                    Do you really want to delete the grade document <strong>{{ description }}</strong>?
                                                {% endblocktrans %}
                                            </span>

                                            <button slot="show-button" type="button" {{ disable_if_archived }} class="btn btn-sm btn-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Delete' %}">
                                                <span class="fas fa-trash"></span>
                                            </button>
                                        </confirmation-modal>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}

                        <script type="module">
                            import { CSRF_HEADERS } from "{% static 'js/csrf-utils.js' %}";

                            document.querySelectorAll("confirmation-modal[data-delete-document]").forEach(modal => {
                                modal.addEventListener("confirmed", async () => {
                                    const response = await fetch("{% url 'grades:delete_grades' %}", {
                                        body: new URLSearchParams({grade_document_id: modal.dataset.deleteDocument}),
                                        headers: CSRF_HEADERS,
                                        method: "POST",
                                    });

                                    if (response.ok) {
                                        const row = modal.closest("tr");
                                        // TODO: animate
                                        row.remove();
                                    } else {
                                        window.alert("{% trans 'The server is not responding.' %}");
                                    }
                                });
                            });
                        </script>
                    </tbody>
                </table>
            {% else %}
                <span class="fst-italic">{% trans 'No grade documents have been uploaded yet' %}</span>
            {% endif %}
        </div>
    </div>
    {% if user.is_grade_publisher %}
        <a href="{% url 'grades:upload_grades' course.id %}" class="btn btn-dark">{% trans 'Upload new midterm grades' %}</a>
        <a href="{% url 'grades:upload_grades' course.id %}?final=true" class="btn btn-dark">{% trans 'Upload new final grades' %}</a>
    {% endif %}
{% endblock %}
