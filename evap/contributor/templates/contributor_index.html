{% extends 'base.html' %}

{% load static %}

{% load infotext_templatetags %}
{% load results_templatetags %}
{% load evaluation_filters %}

{% block title %}{% translate 'Your EvaP' %} - {{ block.super }}{% endblock %}

{% block content %}
    {{ block.super }}
    {% show_infotext 'contributor_index' %}


    <div class="row mb-3 align-items-end">
        <h3 class="col-4 mb-0">
            Your Contributions
        </h3>
        <div class="col-8 d-flex">
            <div class="me-2 text-nowrap">
                <a href="{% url 'contributor:export' %}" class="btn btn-light">{% translate 'Export results' %}</a>
            </div>
            {% if user.is_delegate %}
                <div class="btn-switch btn-switch-light me-2">
                    <div class="btn-switch-label">
                        <span class="fas fa-people-arrows-left-right me-1"></span>
                        {% translate 'Delegated evaluations' %}
                    </div>
                    <div class="btn-switch btn-group">
                        <a href="{% url 'contributor:index' %}?show_delegated=true" role="button" class="btn btn-light{% if show_delegated %} active{% endif %}">
                            {% translate 'Show' %}
                        </a>
                        <a href="{% url 'contributor:index' %}?show_delegated=false" role="button" class="btn btn-light{% if not show_delegated %} active{% endif %}">
                            {% translate 'Hide' %}
                        </a>
                    </div>
                </div>
            {% endif %}
            {% if user.show_startpage_button %}
                <div class="me-2">
                    {% include 'startpage_button.html' with page='CO' btnClass='btn' %}
                </div>
            {% endif %}
            <div class="input-group">
                <input type="search" name="search" class="form-control" placeholder="{% translate 'Search...' %}" />
                <button class="btn btn-light text-secondary" type="button" data-reset="search" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'Clear search filter' %}">
                    <span class="fas fa-delete-left"></span>
                </button>
            </div>
        </div>
    </div>

    {% for semester in semester_list %}
        {% if semester.evaluations %}
        <div class="card{% if not forloop.last %} mb-3{% endif %}{% if semester.is_active %} card-outline-primary{% endif %}">
            <div class="card-header">
                {{ semester.semester_name }}
            </div>
            <div class="card-body">
                <!-- TODO-RK: Disable sorting in columns -->
                <div class="grid-header contributor-grid-row d-none d-lg-grid">
                    <div data-col="name" class="col-order">{% translate 'Name' %}</div>
                    <div data-col="state" class="col-order">{% translate 'State' %}</div>
                    <div data-col="period" class="col-order">{% translate 'Evaluation period' %}</div>
                    <div data-col="voters" class="col-order">{% translate 'Voters' %}</div>
                    <div data-col="result" class="col-order">{% translate 'Results and actions' %}</div>
                </div>
                <div id="contributor-grid">
                    {% regroup semester.evaluations by course as course_evaluations %}
                    {% for course, evaluations in course_evaluations|dictsort:"grouper.name" %}
                        {% if course.evaluation_count > 1 %}
                            <div>
                                {% include 'contributor_index_course.html' %}
                                {% for evaluation in evaluations|dictsort:"name" %}
                                    {% include 'contributor_index_evaluation.html' with links_to_results_page=evaluation|can_results_page_be_seen_by:request.user is_subentry=True %}
                                {% endfor %}
                            </div>
                        {% else %}
                            {% for evaluation in evaluations|dictsort:"name" %}
                                {% include 'contributor_index_evaluation.html' with links_to_results_page=evaluation|can_results_page_be_seen_by:request.user is_subentry=False %}
                            {% endfor %}
                        {% endif %}   
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% endblock %}

<!-- TODO-RK: Enable searching through search bar -->
{% block additional_javascript %}
    <script type="module">
        import {TableGrid} from "{% static 'js/datagrid.js' %}";
        document.querySelectorAll(".contributor-table").forEach(table => {
            new TableGrid({
                storageKey: "contributor-grid",
                searchInput: document.querySelector("input[name=search]"),
                resetSearch: document.querySelector("[data-reset=search]"),
            }).init();
        });
    </script>
{% endblock %}
